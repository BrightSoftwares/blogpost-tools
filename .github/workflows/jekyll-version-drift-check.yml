name: Jekyll Version Drift Check

on:
  schedule:
    # Run on the 1st of every month at 9:00 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      send_report:
        description: 'Send email report'
        required: false
        default: 'true'
        type: boolean

env:
  TARGET_JEKYLL_VERSION: "4.2.2"
  TARGET_RUBY_VERSION: "3.4"

jobs:
  check-versions:
    runs-on: ubuntu-latest
    outputs:
      report: ${{ steps.check.outputs.report }}
      has_drift: ${{ steps.check.outputs.has_drift }}
    steps:
      - name: Check Jekyll versions across repositories
        id: check
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          set -e

          # List of Jekyll repositories to check
          REPOS=(
            "BrightSoftwares/corporate-website"
            "BrightSoftwares/foolywise.com"
            "BrightSoftwares/ieatmyhealth.com"
            "BrightSoftwares/joyousbyflora-posts"
            "BrightSoftwares/keke.li"
            "BrightSoftwares/modabyflora-corporate"
            "BrightSoftwares/olympics-paris2024.com"
            "BrightSoftwares/eagles-techs.com"
            "Causting/causting.com"
            "Causting/space-up-planet.com"
            "sergioafanou/smart-cv"
            "sergioafanou/blog"
          )

          echo "# Jekyll Version Drift Report" > report.md
          echo "" >> report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
          echo "**Target Jekyll Version:** $TARGET_JEKYLL_VERSION" >> report.md
          echo "**Target Ruby Version:** $TARGET_RUBY_VERSION" >> report.md
          echo "" >> report.md
          echo "## Repository Status" >> report.md
          echo "" >> report.md
          echo "| Repository | Jekyll Version | Ruby 3.4 Gems | Status |" >> report.md
          echo "|------------|----------------|---------------|--------|" >> report.md

          has_drift="false"
          drift_repos=""
          missing_gems_repos=""

          for repo in "${REPOS[@]}"; do
            echo "Checking $repo..."

            # Get Gemfile content
            gemfile=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://raw.githubusercontent.com/$repo/main/Gemfile" 2>/dev/null || \
              curl -s -H "Authorization: token $GH_TOKEN" \
              "https://raw.githubusercontent.com/$repo/master/Gemfile" 2>/dev/null || echo "")

            if [[ -z "$gemfile" || "$gemfile" == "404: Not Found" ]]; then
              echo "| $repo | N/A | N/A | ⚠️ No Gemfile |" >> report.md
              continue
            fi

            # Extract Jekyll version
            jekyll_version=$(echo "$gemfile" | grep -oP 'gem "jekyll".*?"~>\s*\K[0-9.]+' || \
                           echo "$gemfile" | grep -oP "gem 'jekyll'.*?'~>\s*\K[0-9.]+" || \
                           echo "unknown")

            # Check for Ruby 3.4 stdlib gems
            ruby34_gems="csv mutex_m logger base64 bigdecimal observer ostruct"
            missing_gems=""
            for gem in $ruby34_gems; do
              if ! echo "$gemfile" | grep -q "gem \"$gem\""; then
                missing_gems="$missing_gems $gem"
              fi
            done

            # Determine status
            status="✅ OK"
            gems_status="✅ All present"

            if [[ "$jekyll_version" != "$TARGET_JEKYLL_VERSION" && "$jekyll_version" != "unknown" ]]; then
              status="⚠️ Version drift"
              has_drift="true"
              drift_repos="$drift_repos\n- $repo ($jekyll_version)"
            fi

            if [[ -n "$missing_gems" ]]; then
              gems_status="❌ Missing:$missing_gems"
              has_drift="true"
              missing_gems_repos="$missing_gems_repos\n- $repo: $missing_gems"
            fi

            echo "| $repo | $jekyll_version | $gems_status | $status |" >> report.md
          done

          echo "" >> report.md

          if [[ "$has_drift" == "true" ]]; then
            echo "## ⚠️ Issues Found" >> report.md
            echo "" >> report.md

            if [[ -n "$drift_repos" ]]; then
              echo "### Version Drift" >> report.md
              echo "The following repositories have a different Jekyll version than target ($TARGET_JEKYLL_VERSION):" >> report.md
              echo -e "$drift_repos" >> report.md
              echo "" >> report.md
            fi

            if [[ -n "$missing_gems_repos" ]]; then
              echo "### Missing Ruby 3.4 Stdlib Gems" >> report.md
              echo "The following repositories are missing required Ruby 3.4 stdlib gems:" >> report.md
              echo -e "$missing_gems_repos" >> report.md
              echo "" >> report.md
            fi

            echo "### Recommended Action" >> report.md
            echo "Run the migration scripts in \`audit-and-align-jekyll-repos/scripts/\` to fix these issues." >> report.md
          else
            echo "## ✅ All Repositories Aligned" >> report.md
            echo "" >> report.md
            echo "All repositories are using Jekyll $TARGET_JEKYLL_VERSION with all required Ruby 3.4 stdlib gems." >> report.md
          fi

          # Output report
          cat report.md

          # Set outputs
          echo "has_drift=$has_drift" >> $GITHUB_OUTPUT

          # Save report as artifact-friendly format
          echo 'report<<EOF' >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-drift-report
          path: report.md
          retention-days: 90

  notify:
    needs: check-versions
    runs-on: ubuntu-latest
    if: ${{ needs.check-versions.outputs.has_drift == 'true' || github.event.inputs.send_report == 'true' }}
    steps:
      - name: Create issue if drift detected
        if: ${{ needs.check-versions.outputs.has_drift == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const report = `${{ needs.check-versions.outputs.report }}`;

            // Check if there's already an open drift issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'jekyll-drift'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## Monthly Drift Check Update\n\n${report}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '⚠️ Jekyll Version Drift Detected',
                body: report,
                labels: ['jekyll-drift', 'maintenance']
              });
            }
